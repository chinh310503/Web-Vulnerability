# API testing
API (Giao diện lập trình ứng dụng) cho phép các hệ thống phần mềm và ứng dụng giao tiếp và chia sẻ dữ liệu. Kiểm thử API rất quan trọng vì lỗ hổng trong API có thể làm suy yếu các khía cạnh cốt lõi về tính bảo mật, tính toàn vẹn và tính khả dụng của trang web.

## Thăm dò API

Để bắt đầu thử nghiệm API, trước tiên bạn cần tìm hiểu càng nhiều thông tin về API càng tốt để khám phá bề mặt tấn công của nó.

Để bắt đầu, bạn nên xác định các điểm cuối API. Đây là các vị trí mà API nhận được yêu cầu về một tài nguyên cụ thể trên máy chủ của nó. Ví dụ, hãy xem xét yêu cầu `GET` sau:

```
GET /api/books HTTP/1.1
Host: example.com
```

Điểm cuối API cho yêu cầu này là `/api/books`. Điều này dẫn đến tương tác với API để lấy danh sách sách từ thư viện. Một điểm cuối API khác có thể là, ví dụ, `/api/books/mystery`, sẽ lấy danh sách sách bí ẩn.

Sau khi xác định được các điểm cuối, bạn cần xác định cách tương tác với chúng. Điều này cho phép bạn xây dựng các yêu cầu HTTP hợp lệ để kiểm tra API. Ví dụ: bạn nên tìm hiểu thông tin về những điều sau:

- Dữ liệu đầu vào mà API xử lý, bao gồm cả tham số bắt buộc và tùy chọn.
- Các loại yêu cầu mà API chấp nhận, bao gồm các phương thức HTTP và định dạng phương tiện được hỗ trợ.
- Giới hạn tốc độ và cơ chế xác thực.

# Tài liệu API
API thường được ghi lại để các nhà phát triển biết cách sử dụng và tích hợp với chúng.

Tài liệu có thể ở cả dạng dễ đọc bằng con người và dạng dễ đọc bằng máy. Tài liệu dễ đọc bằng con người được thiết kế để các nhà phát triển hiểu cách sử dụng API. Tài liệu có thể bao gồm các giải thích chi tiết, ví dụ và tình huống sử dụng. Tài liệu dễ đọc bằng máy được thiết kế để phần mềm xử lý nhằm tự động hóa các tác vụ như tích hợp và xác thực API. Tài liệu được viết ở các định dạng có cấu trúc như JSON hoặc XML.

Tài liệu API thường được công khai, đặc biệt nếu API dành cho các nhà phát triển bên ngoài sử dụng. Nếu đúng như vậy, hãy luôn bắt đầu quá trình trinh sát của bạn bằng cách xem xét tài liệu.

## Khám phá tài liệu API
Ngay cả khi tài liệu về API không được công khai, bạn vẫn có thể truy cập vào đó bằng cách duyệt các ứng dụng sử dụng API.

Để thực hiện việc này, bạn có thể sử dụng Burp Scanner để thu thập API. Bạn cũng có thể duyệt các ứng dụng theo cách thủ công bằng trình duyệt của Burp. Tìm kiếm các điểm cuối có thể tham chiếu đến tài liệu API, ví dụ:

```
/api
/swagger/index.html
/openapi.json 
```

Nếu bạn xác định điểm cuối cho một tài nguyên, hãy đảm bảo điều tra đường dẫn cơ sở. Ví dụ: nếu bạn xác định điểm cuối tài nguyên `/api/swagger/v1/users/123`, thì bạn nên điều tra các đường dẫn sau:

```
/api/swagger/v1
/api/swagger
/api
```

Bạn cũng có thể sử dụng danh sách các đường dẫn phổ biến để tìm tài liệu bằng Intruder của Burpsuite.

# Xác định điểm cuối API
Bạn cũng có thể thu thập nhiều thông tin bằng cách duyệt các ứng dụng sử dụng API. Điều này thường đáng làm ngay cả khi bạn có quyền truy cập vào tài liệu API, vì đôi khi tài liệu có thể không chính xác hoặc lỗi thời.

Trong khi duyệt ứng dụng, hãy tìm các mẫu gợi ý điểm cuối API trong cấu trúc URL, chẳng hạn như `/api/`. Ngoài ra, hãy tìm các tệp JavaScript. Chúng có thể chứa các tham chiếu đến điểm cuối API mà bạn chưa kích hoạt trực tiếp qua trình duyệt web.

## Tương tác với các điểm cuối API
Sau khi xác định được các điểm cuối API, hãy tương tác với chúng bằng Burp Repeater và Burp Intruder. Điều này cho phép bạn quan sát hành vi của API và khám phá thêm bề mặt tấn công. Ví dụ: bạn có thể điều tra cách API phản hồi khi thay đổi phương thức HTTP và loại phương tiện.

Khi bạn tương tác với các điểm cuối API, hãy xem xét kỹ các thông báo lỗi và các phản hồi khác. Đôi khi chúng bao gồm thông tin mà bạn có thể sử dụng để xây dựng một yêu cầu HTTP hợp lệ.

## Xác định các phương thức HTTP được hỗ trợ
Phương thức HTTP chỉ định hành động sẽ được thực hiện trên một tài nguyên. Ví dụ:

- GET- Lấy dữ liệu từ một nguồn tài nguyên.
- PATCH- Áp dụng những thay đổi một phần cho một tài nguyên.
- OPTIONS- Truy xuất thông tin về các loại phương thức yêu cầu có thể được sử dụng trên một tài nguyên.

Điểm cuối API có thể hỗ trợ các phương thức HTTP khác nhau. Do đó, điều quan trọng là phải kiểm tra tất cả các phương thức tiềm năng khi bạn đang điều tra các điểm cuối API. Điều này có thể cho phép bạn xác định chức năng điểm cuối bổ sung, mở ra nhiều bề mặt tấn công hơn.

Ví dụ, điểm cuối `/api/tasks` có thể hỗ trợ các phương pháp sau:

- GET /api/tasks- Lấy danh sách các nhiệm vụ.
- POST /api/tasks- Tạo một nhiệm vụ mới.
- DELETE /api/tasks/1- Xóa một tác vụ.

## Xác định các loại nội dung được hỗ trợ
Điểm cuối API thường mong đợi dữ liệu ở một định dạng cụ thể. Do đó, chúng có thể hoạt động khác nhau tùy thuộc vào loại nội dung của dữ liệu được cung cấp trong yêu cầu. Thay đổi loại nội dung có thể cho phép bạn:

- Kích hoạt lỗi tiết lộ thông tin hữu ích.
- Bỏ qua các biện pháp phòng thủ có khiếm khuyết.
- Tận dụng sự khác biệt trong logic xử lý. Ví dụ, API có thể an toàn khi xử lý dữ liệu JSON nhưng dễ bị tấn công tiêm nhiễm khi xử lý XML.

# Tìm kiếm các tham số ẩn
Khi bạn đang thực hiện API recon, bạn có thể tìm thấy các tham số không có trong tài liệu mà API hỗ trợ. Bạn có thể thử sử dụng các tham số này để thay đổi hành vi của ứng dụng. 

## Lỗ hổng phân công hàng loạt
Việc gán hàng loạt (còn được gọi là tự động liên kết) có thể vô tình tạo ra các tham số ẩn. Nó xảy ra khi các khung phần mềm tự động liên kết các tham số yêu cầu với các trường trên một đối tượng nội bộ. Do đó, việc gán hàng loạt có thể dẫn đến ứng dụng hỗ trợ các tham số mà nhà phát triển không bao giờ có ý định xử lý.

## Xác định các tham số ẩn
Vì việc gán hàng loạt tạo ra các tham số từ các trường đối tượng nên bạn thường có thể xác định các tham số ẩn này bằng cách kiểm tra thủ công các đối tượng được API trả về.

Ví dụ, hãy xem xét một yêu cầu `PATCH /api/users/` cho phép người dùng cập nhật tên người dùng và email của họ và bao gồm JSON sau:

```
{
    "username": "wiener",
    "email": "wiener@example.com",
}
```

Yêu cầu đồng thời `GET /api/users/123` trả về `JSON` sau:

```
{
    "id": 123,
    "name": "John Doe",
    "email": "john@example.com",
    "isAdmin": "false"
}
```

Điều này có thể chỉ ra rằng các tham số ẩn `id` và tham số `isAdmin` được liên kết với đối tượng người dùng nội bộ, cùng với các tham số tên người dùng và email đã cập nhật.

## Kiểm tra lỗ hổng phân bổ hàng loạt
Để kiểm tra xem bạn có thể sửa đổi giá trị tham số `isAdmin` được liệt kê hay không, hãy thêm nó vào yêu cầu `PATCH`:

```
{
    "username": "wiener",
    "email": "wiener@example.com",
    "isAdmin": false,
}
```

Ngoài ra, hãy gửi yêu cầu `PATCH` có giá trị tham số `isAdmin` không hợp lệ:

```
{
    "username": "wiener",
    "email": "wiener@example.com",
    "isAdmin": "foo",
}
```

Nếu ứng dụng hoạt động khác, điều này có thể cho thấy giá trị không hợp lệ ảnh hưởng đến logic truy vấn, nhưng giá trị hợp lệ thì không. Điều này có thể chỉ ra rằng người dùng có thể cập nhật tham số thành công.

Sau đó, bạn có thể gửi yêu cầu `PATCH` với giá trị tham số `isAdmin` được đặt thành true, để thử khai thác lỗ hổng:

```
{
    "username": "wiener",
    "email": "wiener@example.com",
    "isAdmin": true,
}
```

Nếu giá trị `isAdmin` trong yêu cầu được liên kết với đối tượng người dùng mà không có xác thực và vệ sinh đầy đủ, người dùng `wiener` có thể được cấp quyền quản trị không đúng cách. Để xác định xem đây có phải là trường hợp hay không, hãy duyệt ứng dụng để wienerxem bạn có thể truy cập chức năng quản trị hay không.

# Ô nhiễm tham số phía máy chủ
Một số hệ thống chứa API nội bộ không thể truy cập trực tiếp từ internet. Ô nhiễm tham số phía máy chủ xảy ra khi một trang web nhúng dữ liệu đầu vào của người dùng vào yêu cầu phía máy chủ tới API nội bộ mà không có mã hóa đầy đủ. Điều này có nghĩa là kẻ tấn công có thể thao túng hoặc chèn tham số, có thể cho phép chúng, ví dụ:

- Ghi đè các tham số hiện có.
- Sửa đổi hành vi của ứng dụng.
- Truy cập dữ liệu trái phép.

Bạn có thể kiểm tra bất kỳ dữ liệu đầu vào nào của người dùng để tìm bất kỳ loại ô nhiễm tham số nào. Ví dụ, tham số truy vấn, trường biểu mẫu, tiêu đề và tham số đường dẫn URL đều có thể bị tấn công.

# Kiểm tra ô nhiễm tham số phía máy chủ trong chuỗi truy vấn
Để kiểm tra ô nhiễm tham số phía máy chủ trong chuỗi truy vấn, hãy đặt các ký tự cú pháp truy vấn như #, &, và = vào dữ liệu đầu vào của bạn và quan sát cách ứng dụng phản hồi.

Hãy xem xét một ứng dụng dễ bị tấn công cho phép bạn tìm kiếm người dùng khác dựa trên tên người dùng của họ. Khi bạn tìm kiếm người dùng, trình duyệt của bạn sẽ đưa ra yêu cầu sau:

`GET /userSearch?name=peter&back=/home`

Để lấy thông tin người dùng, máy chủ sẽ truy vấn API nội bộ với yêu cầu sau:

`GET /users/search?name=peter&publicProfile=true`

## Cắt bớt chuỗi truy vấn
Bạn có thể sử dụng ký tự được mã hóa URL #để cố gắng cắt bớt yêu cầu phía máy chủ. Để giúp bạn diễn giải phản hồi, bạn cũng có thể thêm một chuỗi sau ký tự #.

Ví dụ, bạn có thể sửa đổi chuỗi truy vấn thành như sau:

`GET /userSearch?name=peter%23foo&back=/home`

Giao diện người dùng sẽ cố gắng truy cập vào URL sau:

`GET /users/search?name=peter#foo&publicProfile=true`

Xem lại phản hồi để tìm manh mối về việc truy vấn có bị cắt bớt hay không. Ví dụ, nếu phản hồi trả về user peter, truy vấn phía máy chủ có thể đã bị cắt bớt. Nếu thông báo lỗi `Invalid name` được trả về, ứng dụng có thể đã được coi `foo` là một phần của tên người dùng. Điều này cho thấy rằng yêu cầu phía máy chủ có thể không bị cắt bớt.

Nếu bạn có thể cắt bớt yêu cầu phía máy chủ, điều này sẽ loại bỏ yêu cầu trường `publicProfile` phải được đặt thành `true`. Bạn có thể khai thác điều này để trả về hồ sơ người dùng không công khai.

## Tiêm tham số không hợp lệ
Bạn có thể sử dụng ký tự được mã hóa URL &để thử thêm tham số thứ hai vào yêu cầu phía máy chủ.

Ví dụ, bạn có thể sửa đổi chuỗi truy vấn thành như sau:

`GET /userSearch?name=peter%26foo=xyz&back=/home`

Điều này dẫn đến yêu cầu phía máy chủ sau đây tới API nội bộ:

`GET /users/search?name=peter&foo=xyz&publicProfile=true`

Xem lại phản hồi để tìm manh mối về cách phân tích cú pháp tham số bổ sung. Ví dụ: nếu phản hồi không thay đổi, điều này có thể chỉ ra rằng tham số đã được đưa vào thành công nhưng bị ứng dụng bỏ qua.

Để có được bức tranh hoàn chỉnh hơn, bạn sẽ cần phải thử nghiệm thêm.

## Tiêm các tham số hợp lệ
Nếu bạn có thể sửa đổi chuỗi truy vấn, sau đó bạn có thể thử thêm tham số hợp lệ thứ hai vào yêu cầu phía máy chủ.

Ví dụ, nếu bạn đã xác định được tham số `email`, bạn có thể thêm tham số đó vào chuỗi truy vấn như sau:

`GET /userSearch?name=peter%26email=foo&back=/home`

Điều này dẫn đến yêu cầu phía máy chủ sau đây tới API nội bộ:

`GET /users/search?name=peter&email=foo&publicProfile=true`

Xem lại phản hồi để tìm manh mối về cách phân tích tham số bổ sung.

## Ghi đè các tham số hiện có
Để xác nhận xem ứng dụng có dễ bị ô nhiễm tham số phía máy chủ hay không, bạn có thể thử ghi đè tham số gốc. Thực hiện việc này bằng cách chèn tham số thứ hai có cùng tên.

Ví dụ, bạn có thể sửa đổi chuỗi truy vấn thành như sau:

`GET /userSearch?name=peter%26name=carlos&back=/home`

Điều này dẫn đến yêu cầu phía máy chủ sau đây tới API nội bộ:

`GET /users/search?name=peter&name=carlos&publicProfile=true`

API nội bộ diễn giải hai tham số `name`. Tác động của điều này phụ thuộc vào cách ứng dụng xử lý tham số thứ hai. Điều này thay đổi tùy theo các công nghệ web khác nhau. Ví dụ:

- PHP chỉ phân tích tham số cuối cùng. Điều này sẽ dẫn đến việc người dùng tìm kiếm `carlos`.
- ASP.NET kết hợp cả hai tham số. Điều này sẽ dẫn đến việc người dùng tìm kiếm `peter`, `carlos`, có thể dẫn đến thông báo lỗi `Invalid username`.
- Node.js / express chỉ phân tích tham số đầu tiên. Điều này sẽ dẫn đến việc người dùng tìm kiếm `peter`, đưa ra kết quả không thay đổi.

Nếu bạn có thể ghi đè tham số gốc, bạn có thể thực hiện khai thác. Ví dụ, bạn có thể thêm `name=administrator` vào yêu cầu. Điều này có thể cho phép bạn đăng nhập với tư cách là người dùng quản trị viên.

## Kiểm tra ô nhiễm tham số phía máy chủ trong đường dẫn REST
API RESTful có thể đặt tên và giá trị tham số trong đường dẫn URL, thay vì chuỗi truy vấn. Ví dụ, hãy xem xét đường dẫn sau:

```
/api/users/123
```

Đường dẫn URL có thể được chia nhỏ như sau:

- `/api` là điểm cuối API gốc.
- `/users` trong trường hợp này là đại diện cho một nguồn tài nguyên `users`.
- `/123` đại diện cho một tham số, ở đây là mã định danh cho người dùng cụ thể.
Hãy xem xét một ứng dụng cho phép bạn chỉnh sửa hồ sơ người dùng dựa trên tên người dùng của họ. Các yêu cầu được gửi đến điểm cuối sau:

`GET /edit_profile.php?name=peter`

Điều này dẫn đến yêu cầu phía máy chủ sau:

`GET /api/private/users/peter`

Kẻ tấn công có thể thao túng các tham số đường dẫn URL phía máy chủ để khai thác API. Để kiểm tra lỗ hổng này, hãy thêm các chuỗi duyệt đường dẫn để sửa đổi các tham số và quan sát cách ứng dụng phản hồi.

Bạn có thể gửi URL được mã hóa `peter/../admin` làm giá trị của tham số `name`:

`GET /edit_profile.php?name=peter%2f..%2fadmin`

Điều này có thể dẫn đến yêu cầu phía máy chủ sau:

`GET /api/private/users/peter/../admin`

Nếu máy khách phía máy chủ hoặc API phía sau chuẩn hóa đường dẫn này, nó có thể được giải quyết thành `/api/private/users/admin`.

## Kiểm tra ô nhiễm tham số phía máy chủ trong các định dạng dữ liệu có cấu trúc
Kẻ tấn công có thể thao túng các tham số để khai thác lỗ hổng trong quá trình xử lý các định dạng dữ liệu có cấu trúc khác của máy chủ, chẳng hạn như JSON hoặc XML. Để kiểm tra điều này, hãy đưa dữ liệu có cấu trúc không mong muốn vào dữ liệu đầu vào của người dùng và xem máy chủ phản hồi như thế nào.

Hãy xem xét một ứng dụng cho phép người dùng chỉnh sửa hồ sơ của họ, sau đó áp dụng các thay đổi của họ bằng một yêu cầu tới API phía máy chủ. Khi bạn chỉnh sửa tên của mình, trình duyệt của bạn sẽ đưa ra yêu cầu sau:

```
POST /myaccount
name=peter
```

Điều này dẫn đến yêu cầu phía máy chủ sau:

```
PATCH /users/7312/update
{"name":"peter"}
```

Bạn có thể thử thêm tham số `access_level` vào yêu cầu như sau:

```
POST /myaccount
name=peter","access_level":"administrator
```

Nếu dữ liệu đầu vào của người dùng được thêm vào dữ liệu JSON phía máy chủ mà không có xác thực hoặc khử trùng đầy đủ, điều này sẽ dẫn đến yêu cầu phía máy chủ sau:

```
PATCH /users/7312/update
{name="peter","access_level":"administrator"}
```

Điều này có thể dẫn đến việc người dùng `peter` được cấp quyền quản trị viên.

Hãy xem xét một ví dụ tương tự, nhưng dữ liệu đầu vào của người dùng phía máy khách là dữ liệu JSON. Khi bạn chỉnh sửa tên của mình, trình duyệt của bạn sẽ thực hiện yêu cầu sau:

```
POST /myaccount
{"name": "peter"}
```

Điều này dẫn đến yêu cầu phía máy chủ sau:

```
PATCH /users/7312/update
{"name":"peter"}
```

Bạn có thể thử thêm access_leveltham số vào yêu cầu như sau:

```
POST /myaccount
{"name": "peter\",\"access_level\":\"administrator"}
```

Nếu dữ liệu đầu vào của người dùng được giải mã, sau đó thêm vào dữ liệu JSON phía máy chủ mà không có mã hóa đầy đủ, điều này sẽ dẫn đến yêu cầu phía máy chủ sau:

```
PATCH /users/7312/update
{"name":"peter","access_level":"administrator"}
```

Một lần nữa, điều này có thể dẫn đến việc người dùng `peter` được cấp quyền quản trị viên.

Tiêm định dạng có cấu trúc cũng có thể xảy ra trong phản hồi. Ví dụ, điều này có thể xảy ra nếu dữ liệu đầu vào của người dùng được lưu trữ an toàn trong cơ sở dữ liệu, sau đó được nhúng vào phản hồi JSON từ API phụ trợ mà không có mã hóa đầy đủ. Bạn thường có thể phát hiện và khai thác tiêm định dạng có cấu trúc trong phản hồi theo cùng cách bạn có thể làm trong yêu cầu.

## Ngăn ngừa ô nhiễm tham số phía máy chủ
Để ngăn ngừa ô nhiễm tham số phía máy chủ, hãy sử dụng danh sách cho phép để xác định các ký tự không cần mã hóa và đảm bảo tất cả dữ liệu đầu vào khác của người dùng được mã hóa trước khi đưa vào yêu cầu phía máy chủ. Bạn cũng nên đảm bảo rằng tất cả dữ liệu đầu vào đều tuân thủ định dạng và cấu trúc mong đợi.

# Ngăn chặn lỗ hổng trong API
Khi thiết kế API, hãy đảm bảo rằng bảo mật được xem xét ngay từ đầu. Cụ thể, hãy đảm bảo rằng bạn:

- Bảo mật tài liệu của bạn nếu bạn không muốn công khai API của mình.
- Đảm bảo tài liệu của bạn được cập nhật để những người kiểm tra hợp pháp có thể thấy toàn bộ bề mặt tấn công của API.
- Áp dụng danh sách cho phép các phương thức HTTP được phép.
- Xác thực loại nội dung được mong đợi cho mỗi yêu cầu hoặc phản hồi.
- Sử dụng thông báo lỗi chung để tránh cung cấp thông tin có thể hữu ích cho kẻ tấn công.
- Sử dụng các biện pháp bảo vệ trên tất cả các phiên bản API của bạn, không chỉ phiên bản sản xuất hiện tại.

Để ngăn chặn lỗ hổng chỉ định hàng loạt, hãy cho phép các thuộc tính mà người dùng có thể cập nhật và chặn các thuộc tính nhạy cảm mà người dùng không nên cập nhật.
