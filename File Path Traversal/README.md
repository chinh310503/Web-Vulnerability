# File Path Traversal

## Path Traversal là gì

Truyền tải đường dẫn còn được gọi là truyền tải thư mục. Những lỗ hổng này cho phép kẻ tấn công đọc các tệp tùy ý trên máy chủ đang chạy ứng dụng. Điều này có thể bao gồm:
- Mã ứng dụng và dữ liệu.
- Thông tin xác thực cho hệ thống back-end.
- Các tập tin hệ điều hành nhạy cảm.

Trong một số trường hợp, kẻ tấn công có thể ghi vào các tệp tùy ý trên máy chủ, cho phép chúng sửa đổi dữ liệu hoặc hành vi của ứng dụng và cuối cùng chiếm toàn quyền kiểm soát máy chủ.

## Đọc các tập tin tùy ý thông qua truyền tải đường dẫn

Hãy tưởng tượng một ứng dụng mua sắm hiển thị hình ảnh các mặt hàng được rao bán. Điều này có thể tải hình ảnh bằng HTML sau:

`<img src="/loadImage?filename=218.png">`

URL `loadImage` nhận tham số `filename` và trả về nội dung của tệp được chỉ định. Các tập tin hình ảnh được lưu trữ trên đĩa ở vị trí `/var/www/images/`. Để trả về một hình ảnh, ứng dụng sẽ thêm tên tệp được yêu cầu vào thư mục cơ sở này và sử dụng API hệ thống tệp để đọc nội dung của tệp. Nói cách khác, ứng dụng đọc từ đường dẫn tệp sau:

`/var/www/images/218.png`

Ứng dụng này không thực hiện biện pháp phòng vệ nào trước các cuộc tấn công truyền tải đường dẫn. Do đó, kẻ tấn công có thể yêu cầu URL sau để lấy tệp `/etc/passwd` từ hệ thống tệp của máy chủ:

`https://insecure-website.com/loadImage?filename=../../../etc/passwd`

Điều này khiến ứng dụng đọc từ đường dẫn tệp sau:

`/var/www/images/../../../etc/passwd`

Trình tự `../` hợp lệ trong đường dẫn tệp và có nghĩa là tăng lên một cấp trong cấu trúc thư mục. Ba chuỗi `../` liên tiếp tăng dần từ `/var/www/images/` - gốc hệ thống tập tin và do đó, tập tin thực sự được đọc là:

`/etc/passwd`

Trên các hệ điều hành dựa trên Unix, đây là tệp tiêu chuẩn chứa thông tin chi tiết về người dùng đã đăng ký trên máy chủ, nhưng kẻ tấn công có thể truy xuất các tệp tùy ý khác bằng kỹ thuật tương tự.

Trên Windows, cả hai chuỗi `../` và `..\` đều là các chuỗi truyền tải thư mục hợp lệ. Sau đây là ví dụ về một cuộc tấn công tương đương nhằm vào máy chủ chạy Windows:

`https://insecure-website.com/loadImage?filename=..\..\..\windows\win.ini`

## Cách phòng tránh

Cách hiệu quả nhất để ngăn chặn các lỗ hổng truyền tải đường dẫn là tránh chuyển hoàn toàn dữ liệu đầu vào do người dùng cung cấp tới API hệ thống tệp. Nhiều chức năng ứng dụng thực hiện việc này có thể được viết lại để cung cấp hành vi tương tự theo cách an toàn hơn.

Nếu bạn không thể tránh chuyển đầu vào do người dùng cung cấp tới API hệ thống tệp, bạn nên sử dụng hai lớp bảo vệ để ngăn chặn các cuộc tấn công:

- Xác thực đầu vào của người dùng trước khi xử lý nó. Lý tưởng nhất là so sánh thông tin đầu vào của người dùng với danh sách trắng các giá trị được phép. Nếu không thể, hãy xác minh rằng dữ liệu đầu vào chỉ chứa nội dung được phép, chẳng hạn như chỉ các ký tự chữ và số.
- Sau khi xác thực đầu vào được cung cấp, hãy thêm đầu vào vào thư mục cơ sở và sử dụng API hệ thống tệp nền tảng để chuẩn hóa đường dẫn. Xác minh rằng đường dẫn chuẩn hóa bắt đầu bằng thư mục cơ sở dự kiến.
