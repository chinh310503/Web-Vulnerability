# Server-side request forgery (SSRF)
## SSRF là gì
Giả mạo yêu cầu phía máy chủ là một lỗ hổng bảo mật web cho phép kẻ tấn công khiến ứng dụng phía máy chủ thực hiện các yêu cầu đến một vị trí ngoài ý muốn.

Trong một cuộc tấn công SSRF điển hình, kẻ tấn công có thể khiến máy chủ tạo kết nối với các dịch vụ chỉ dành cho nội bộ trong cơ sở hạ tầng của tổ chức. Trong các trường hợp khác, họ có thể buộc máy chủ kết nối với các hệ thống bên ngoài tùy ý. Điều này có thể làm rò rỉ dữ liệu nhạy cảm, chẳng hạn như thông tin xác thực ủy quyền.

## Tác động của tấn công SSRF là gì
Một cuộc tấn công SSRF thành công thường có thể dẫn đến các hành động trái phép hoặc truy cập dữ liệu trong tổ chức. Điều này có thể nằm trong ứng dụng dễ bị tấn công hoặc trên các hệ thống phụ trợ khác mà ứng dụng có thể giao tiếp. Trong một số trường hợp, lỗ hổng SSRF có thể cho phép kẻ tấn công thực hiện lệnh tùy ý.

Một khai thác SSRF gây ra kết nối đến các hệ thống của bên thứ ba bên ngoài có thể dẫn đến các cuộc tấn công ác ý tiếp theo. Những cuộc tấn công này có vẻ như bắt nguồn từ tổ chức lưu trữ ứng dụng dễ bị tấn công.

## Các cuộc tấn công SSRF phổ biến

Các cuộc tấn công SSRF thường khai thác các mối quan hệ tin cậy để leo thang một cuộc tấn công từ ứng dụng dễ bị tấn công và thực hiện các hành động trái phép. Các mối quan hệ tin cậy này có thể tồn tại liên quan đến máy chủ hoặc liên quan đến các hệ thống phụ trợ khác trong cùng một tổ chức.

**Các cuộc tấn công SSRF vào máy chủ**

Trong một cuộc tấn công SSRF vào máy chủ, kẻ tấn công khiến ứng dụng thực hiện một yêu cầu HTTP trở lại máy chủ đang lưu trữ ứng dụng, thông qua giao diện mạng vòng lặp của nó. Điều này thường liên quan đến việc cung cấp một URL có tên máy chủ như 127.0.0.1(một địa chỉ IP được dành riêng trỏ đến bộ điều hợp vòng lặp) hoặc localhost(một tên thường được sử dụng cho cùng một bộ điều hợp).

Ví dụ: hãy tưởng tượng một ứng dụng mua sắm cho phép người dùng xem liệu một mặt hàng có còn hàng ở một cửa hàng cụ thể hay không. Để cung cấp thông tin chứng khoán, ứng dụng phải truy vấn các API REST phụ trợ khác nhau. Nó thực hiện điều này bằng cách chuyển URL đến điểm cuối API back-end có liên quan thông qua yêu cầu HTTP front-end. Khi người dùng xem trạng thái tồn kho của một mặt hàng, trình duyệt của họ sẽ đưa ra yêu cầu sau:

```
POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://stock.weliketoshop.net:8080/product/stock/check%3FproductId%3D6%26storeId%3D1
```
Điều này khiến máy chủ gửi yêu cầu tới URL đã chỉ định, lấy trạng thái kho và trả về cho người dùng.

Trong ví dụ này, kẻ tấn công có thể sửa đổi yêu cầu chỉ định URL cục bộ cho máy chủ:

```
POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://localhost/admin
```
Máy chủ tìm nạp nội dung của URL ```/admin``` và trả lại cho người dùng.

Kẻ tấn công có thể truy cập URL ```/admin```, nhưng chức năng quản trị thường chỉ có thể truy cập được đối với người dùng đã xác thực. Điều này có nghĩa là kẻ tấn công sẽ không thấy bất kỳ điều gì đáng quan tâm. Tuy nhiên, nếu yêu cầu đến URL /adminđến từ máy cục bộ, các điều khiển truy cập thông thường sẽ bị bỏ qua. Ứng dụng cấp quyền truy cập đầy đủ vào chức năng quản trị, vì yêu cầu có vẻ như bắt nguồn từ một vị trí đáng tin cậy.

**Tấn công SSRF vào các hệ thống phụ trợ khác**

Trong một số trường hợp, máy chủ ứng dụng có thể tương tác với các hệ thống phụ trợ mà người dùng không thể truy cập trực tiếp. Các hệ thống này thường có địa chỉ IP riêng không thể định tuyến. Các hệ thống phụ trợ thường được bảo vệ bởi cấu trúc mạng, do đó chúng thường có thế trận bảo mật yếu hơn. Trong nhiều trường hợp, các hệ thống phụ trợ nội bộ chứa chức năng nhạy cảm có thể được truy cập mà không cần xác thực bởi bất kỳ ai có thể tương tác với các hệ thống.

Trong ví dụ trước, hãy tưởng tượng có một giao diện quản trị tại URL back-end ```https://192.168.0.68/admin```. Kẻ tấn công có thể gửi yêu cầu sau để khai thác lỗ hổng SSRF và truy cập vào giao diện quản trị:

```
POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://192.168.0.68/admin
```

## Bỏ qua các biện pháp phòng thủ SSRF phổ biến

**SSRF với bộ lọc đầu vào dựa trên danh sách đen**

Một số ứng dụng chặn đầu vào có chứa tên máy chủ như `127.0.0.1` và `localhost` hoặc các URL nhạy cảm như `/admin`. Trong tình huống này, bạn thường có thể phá vỡ bộ lọc bằng các kỹ thuật sau:

- Sử dụng biểu diễn IP thay thế của `127.0.0.1`, chẳng hạn như `2130706433`, `017700000001`, hoặc ```127.1```.
- Đăng ký tên miền của riêng bạn có độ phân giải là `127.0.0.1`. Bạn có thể sử dụng `spoofed.burpcollaborator.net` cho mục đích này.
- Làm tối nghĩa các chuỗi bị chặn bằng cách sử dụng mã hóa URL hoặc thay đổi chữ hoa chữ thường.
- Cung cấp một URL mà bạn kiểm soát, chuyển hướng đến URL mục tiêu. Hãy thử sử dụng các mã chuyển hướng khác nhau, cũng như các giao thức khác nhau cho URL mục tiêu. Ví dụ, việc chuyển đổi từ URL `http:` sang `https:` trong quá trình chuyển hướng đã được chứng minh là có thể bỏ qua một số bộ lọc chống SSRF.

**SSRF với các bộ lọc đầu vào dựa trên danh sách trắng**

Một số ứng dụng chỉ cho phép các đầu vào khớp, danh sách trắng các giá trị được phép. Bộ lọc có thể tìm kiếm sự khớp ở đầu đầu vào hoặc nằm trong đầu vào. Bạn có thể bỏ qua bộ lọc này bằng cách khai thác sự không nhất quán trong phân tích cú pháp URL.

Đặc tả URL chứa một số tính năng có thể bị bỏ qua khi URL triển khai phân tích cú pháp và xác thực tùy ý bằng phương pháp này:

- Bạn có thể nhúng thông tin xác thực vào URL trước tên máy chủ bằng cách sử dụng ký tự @. Ví dụ:
`https://expected-host:fakepassword@evil-host`

- Bạn có thể sử dụng ký tự # để chỉ ra một đoạn URL. Ví dụ:
`https://evil-host#expected-host`

- Bạn có thể tận dụng hệ thống phân cấp đặt tên DNS để đưa dữ liệu đầu vào cần thiết vào tên DNS đủ điều kiện mà bạn kiểm soát. Ví dụ:
`https://expected-host.evil-host`

- Bạn có thể mã hóa các ký tự URL để gây nhầm lẫn cho mã phân tích cú pháp URL. Điều này đặc biệt hữu ích nếu mã triển khai bộ lọc xử lý các ký tự được mã hóa URL khác với mã thực hiện yêu cầu HTTP phía sau. Bạn cũng có thể thử mã hóa kép các ký tự; một số máy chủ giải mã URL đệ quy đầu vào mà chúng nhận được, điều này có thể dẫn đến sự khác biệt hơn nữa.
- Bạn có thể sử dụng kết hợp các kỹ thuật này với nhau.

**Bỏ qua các bộ lọc SSRF thông qua chuyển hướng mở**

Đôi khi có thể vượt qua các biện pháp phòng vệ dựa trên bộ lọc bằng cách khai thác lỗ hổng chuyển hướng mở.

Trong ví dụ trước, hãy tưởng tượng URL do người dùng gửi được xác thực nghiêm ngặt để ngăn chặn việc khai thác hành vi SSRF có chủ đích. Tuy nhiên, ứng dụng có URL được phép chứa lỗ hổng chuyển hướng mở. Với điều kiện API được sử dụng để thực hiện yêu cầu HTTP ở phía sau hỗ trợ chuyển hướng, bạn có thể xây dựng một URL đáp ứng bộ lọc và dẫn đến yêu cầu được chuyển hướng đến mục tiêu phía sau mong muốn.

Ví dụ: ứng dụng chứa lỗ hổng chuyển hướng mở trong đó URL sau:

`/product/nextProduct?currentProductId=6&path=http://evil-user.net`

trả về một chuyển hướng tới:

`http://evil-user.net`

Bạn có thể tận dụng lỗ hổng chuyển hướng mở để vượt qua bộ lọc URL và khai thác lỗ hổng SSRF như sau:

```
POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://weliketoshop.net/product/nextProduct?currentProductId=6&path=http://192.168.0.68/admin
```
Khai thác SSRF này hoạt động vì ứng dụng đầu tiên xác thực rằng stockAPIURL được cung cấp nằm trên một miền được phép, và đúng là như vậy. Sau đó, ứng dụng yêu cầu URL được cung cấp, kích hoạt chuyển hướng mở. Nó theo chuyển hướng và thực hiện yêu cầu đến URL nội bộ do kẻ tấn công lựa chọn.

## Lỗ hổng SSRF mù

**SSRF mù là gì**

Lỗ hổng SSRF mù phát sinh khi một ứng dụng có thể được kích hoạt để gửi yêu cầu HTTP ở phía sau tới một URL được cung cấp, nhưng phản hồi từ yêu cầu ở phía sau không được trả về trong phản hồi ở phía trước của ứng dụng.

**Tác động của lỗ hổng SSRF mù là gì**

Tác động của các lỗ hổng SSRF mù thường thấp hơn so với các lỗ hổng SSRF được thông báo đầy đủ do tính chất một chiều của chúng. Chúng không thể bị khai thác một cách tầm thường để lấy dữ liệu nhạy cảm từ các hệ thống phụ trợ, mặc dù trong một số trường hợp, chúng có thể bị khai thác để thực thi mã từ xa hoàn toàn.

**Cách tìm và khai thác lỗ hổng SSRF mù**

Cách đáng tin cậy nhất để phát hiện các lỗ hổng SSRF mù là sử dụng các kỹ thuật ngoài băng tần (OAST). Điều này liên quan đến việc cố gắng kích hoạt yêu cầu HTTP tới hệ thống bên ngoài mà bạn kiểm soát và giám sát các tương tác mạng với hệ thống đó.

Cách dễ nhất và hiệu quả nhất để sử dụng các kỹ thuật out-of-band là sử dụng Burp Collaborator . Bạn có thể sử dụng Burp Collaborator để tạo các tên miền duy nhất, gửi chúng dưới dạng tải trọng đến ứng dụng và theo dõi mọi tương tác với các miền đó. Nếu một yêu cầu HTTP đến được quan sát thấy đến từ ứng dụng thì nó dễ bị tấn công bởi SSRF.

Chỉ xác định một lỗ hổng SSRF ẩn có thể kích hoạt các yêu cầu HTTP ngoài băng tần không tự nó cung cấp một tuyến đường để khai thác. Vì bạn không thể xem phản hồi từ yêu cầu phụ trợ, nên không thể sử dụng hành vi này để khám phá nội dung trên các hệ thống mà máy chủ ứng dụng có thể tiếp cận. Tuy nhiên, nó vẫn có thể được tận dụng để thăm dò các lỗ hổng khác trên chính máy chủ hoặc trên các hệ thống phụ trợ khác. Bạn có thể quét không gian địa chỉ IP nội bộ một cách mù quáng, gửi các tải trọng được thiết kế để phát hiện các lỗ hổng đã biết. Nếu các tải trọng đó cũng sử dụng các kỹ thuật ẩn ngoài băng tần, thì bạn có thể phát hiện ra một lỗ hổng nghiêm trọng trên một máy chủ nội bộ chưa được vá.

Một cách khác để khai thác lỗ hổng SSRF mù là khiến ứng dụng kết nối với hệ thống do kẻ tấn công kiểm soát và trả về phản hồi độc hại cho máy khách HTTP thực hiện kết nối. Nếu bạn có thể khai thác lỗ hổng nghiêm trọng ở phía máy khách trong triển khai HTTP của máy chủ, bạn có thể thực hiện được việc thực thi mã từ xa trong cơ sở hạ tầng ứng dụng.

## Tìm bề mặt tấn công ẩn cho các lỗ hổng SSRF

Nhiều lỗ hổng giả mạo yêu cầu phía máy chủ rất dễ tìm thấy vì lưu lượng thông thường của ứng dụng liên quan đến các tham số yêu cầu chứa URL đầy đủ. Các ví dụ khác về SSRF khó xác định hơn.

**URL một phần trong yêu cầu**

Đôi khi, ứng dụng chỉ đặt tên máy chủ hoặc một phần đường dẫn URL vào tham số yêu cầu. Sau đó, giá trị được gửi sẽ được kết hợp phía máy chủ vào một URL đầy đủ được yêu cầu. Nếu giá trị được nhận dạng dễ dàng dưới dạng tên máy chủ hoặc đường dẫn URL thì bề mặt tấn công tiềm ẩn có thể rõ ràng. Tuy nhiên, khả năng khai thác dưới dạng SSRF đầy đủ có thể bị hạn chế do bạn không kiểm soát toàn bộ URL được yêu cầu.

**URL trong định dạng dữ liệu**

Một số ứng dụng truyền dữ liệu ở các định dạng có thông số kỹ thuật cho phép bao gồm các URL có thể được trình phân tích cú pháp dữ liệu yêu cầu đối với định dạng đó. Một ví dụ rõ ràng về điều này là định dạng dữ liệu XML, định dạng này đã được sử dụng rộng rãi trong các ứng dụng web để truyền dữ liệu có cấu trúc từ máy khách đến máy chủ. Khi một ứng dụng chấp nhận dữ liệu ở định dạng XML và phân tích cú pháp dữ liệu đó, nó có thể dễ bị tiêm XXE . Nó cũng có thể dễ bị SSRF thông qua XXE. Chúng tôi sẽ đề cập đến vấn đề này chi tiết hơn khi xem xét các lỗ hổng chèn XXE.

**SSRF thông qua tiêu đề Referer**

Một số ứng dụng sử dụng phần mềm phân tích phía máy chủ để theo dõi khách truy cập. Phần mềm này thường ghi lại tiêu đề Người giới thiệu trong các yêu cầu để có thể theo dõi các liên kết đến. Thông thường, phần mềm phân tích sẽ truy cập bất kỳ URL nào của bên thứ ba xuất hiện trong tiêu đề Người giới thiệu. Điều này thường được thực hiện để phân tích nội dung của các trang web giới thiệu, bao gồm cả văn bản liên kết được sử dụng trong các liên kết đến. Do đó, tiêu đề Người giới thiệu thường là bề mặt tấn công hữu ích cho các lỗ hổng SSRF.

## Các cách ngăn chặn SSRF

Một số ý tưởng cho việc phòng chống tấn công lỗ hổng SSRF có thể kể đến như:

- Kiểm tra các thông tin phản hồi cho người dùng: Thay vì trực tiếp phản hồi các thông tin yêu cầu từ người dùng, chúng ta nên có thêm các bước kiểm tra tính hợp lệ của thông tin, nguồn thông tin và nội dung thông tin.
- Thống nhất các thông báo lỗi, hạn chế kẻ tấn công dựa vào sự khác nhau giữa các thông báo lỗi khai thác thông tin hữu ích.
- Áp dụng kết hợp các biện pháp ngăn chặn lỗ hổng SSRF như blacklist-based, whitelist-based, block IP có dấu hiệu lạ, ...
- Ngăn chặn các wrapper không cần thiết, chẳng hạn file://, gopher://, ftp://, ...
